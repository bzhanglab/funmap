<!doctype html>
<html>

<head>
    <meta charset="utf-8" />
    <title>FunMap Gene Neighborhood Search</title>
    <script src="../assets/js/echarts.min.js"></script>
    <script src="../assets/js/min/dag.min.js"></script>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link rel="stylesheet" type="text/css" href="../assets/css/funmap.css" />
    <link rel="stylesheet" type="text/css" href="../assets/css/gd.min.css" />
    <link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
    <link rel="manifest" href="../site.webmanifest">
    <link rel="mask-icon" href="../safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="theme-color" content="#ffffff">
    <style>
        html {
            background: none;
        }

        body {
            overflow-x: hidden;
        }

        h1 {
            text-align: center;
        }

        .container {
            width: 100%;
            display: flex;
            flex-direction: row;
            flex-wrap: wrap;
            justify-content: center;
            -webkit-box-sizing: border-box;
            -moz-box-sizing: border-box;
            box-sizing: border-box;
        }

        button {
            display: inline-block;
            font-size: 1.1875rem;
            line-height: var(--leading);
            font-family: var(--font);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            font-weight: 400;
            box-sizing: border-box;
            width: fit-content;
            height: 2.5rem;
            margin-top: 0;
            padding: 5px;
            border: 2px solid var(--color-body);
            border-radius: 0;
            appearance: none;
            box-shadow: none;
            height: 2.5em;
        }

        .text {
            height: 2.5em;
            width: 50%;
        }

        #filler {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .result {
            display: flex;
            align-content: center;
            vertical-align: center;
            width: 70%;
            height: 50%;
        }

        #result_container {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            margin-top: 5%;
            width: 100%;
        }

        .info_div {
            min-width: 60%;
            max-width: 60%;
            padding-right: 5%;
        }

        .info_heading {
            margin-bottom: 0pt;
        }

        .subtitle {
            color: var(--color-body-light)
        }

        table:last-child {
            margin-bottom: 5%;
        }
    </style>
</head>

<body>
    <div id="filler" style="height: 100%;">
        <h1>FunMap Gene Neighborhood Search</h1>
        <div class="centering">
            <p style="color: var(--color-body-light); text-align: center;">Gene Neighborhood: Top 50 nodes with highest
                random walk
                probability starting from a gene of interest.</p>
            <h3 style="text-align: center">Gene Symbol</h3>
            <div class="container">
                <input type="text" list="genes" class="text" id="gene_id" name="gene_id" value="RBM34" />
                <datalist id="genes"></datalist>
                <button id="search_button">Search</button>

            </div>
            <p style="color: var(--color-error); text-align: center; font-size: calc(var(--unit)); display: block; flex: 1;"
                id="gene_search_error"></p>
        </div>
        <h4 id="gene_title">Gene: </h4>
        <div class="result result_container" style="padding-bottom: 5%;">
            <div class="info_div" id="left_div">
                <h5 style="margin-bottom: 0pt">GO Enrichment</h5>
                <small style="color: var(--color-body-light)">Highest enriched GO terms for gene neighborhood using
                    over-representation analysis</small>
                <table style="margin-top: 1em; margin-bottom: 5%;">
                    <thead>
                        <tr>
                            <th>GO Category</th>
                            <th>Go ID</th>
                            <th>Go Term</th>
                            <th>FDR</th>
                        </tr>
                    </thead>
                    <tbody id="table_body"></tbody>
                </table>
                <div id="left_div_child" style="height: 100%; width: 100%;"></div>
                <!-- <button id="download_button">Download Neighborhood</button> -->
            </div>
            <div style="flex-grow:1;">
                <div id="dag" style="width: 100%; height: 100%; border: 1px solid black"></div>
                <p style="color: var(--color-body-light); font-size: var(--unit); text-align: center">
                    Gene significance across 5 cohorts (signed -log<sub>10</sub> meta-<i>p</i>).<br>Scroll to zoom,
                    click and drag to move nodes.
                <p>
                <h5 style="margin-bottom: 0pt">Neighborhood Members</h5>
                <div id="members">
                </div>
            </div>
        </div>
        <script>
            let gene_json = "../data/genes.json";
            let gene_element = "genes";
            let all_gene_data = [];
            let gene_button = document.getElementById("search_button");
            let displayed_chart = null;
            function download(json_object, file_name = "clique.json") {
                let dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(json_object));
                let downloadAnchorNode = document.createElement("a");
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute("download", file_name);
                document.body.appendChild(downloadAnchorNode);
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
            }

            function isNumeric(n) {
                const num = parseFloat(n);
                return !Number.isNaN(num) && Number.isFinite(num);
            }

            function createTable(data) {
                const table = document.createElement("table");
                const thead = document.createElement("thead");
                const tbody = document.createElement("tbody");
                const header = document.createElement("tr");
                for (let i = 0; i < data.columns.length; i++) {
                    const th = document.createElement("th");
                    const val = data.columns[i];
                    th.innerHTML = val;
                    header.appendChild(th);
                }
                thead.appendChild(header);
                table.appendChild(thead);
                const has_summary = !!data.has_summary;
                for (let i = 0; i < data.data.length; i++) {
                    const row = document.createElement("tr");
                    if (has_summary && i === data.data.length - 1) {
                        row.style.fontWeight = "bold";
                        row.style.borderBottom = "0px solid var(--color-body)";
                    }
                    for (let j = 0; j < data.data[i].length; j++) {
                        const td = document.createElement("td");
                        let val = data.data[i][j];
                        if (isNumeric(val)) {
                            val = parseFloat(val);
                            if (val === 0) {
                                val = "< 2.20e-16";
                            } else if (Math.abs(val) > 0.001 && Math.abs(val) < 1000) {
                                val = val.toPrecision(3);
                            } else {
                                val = val.toExponential(2);
                            }
                        } else if (val == null || val == "None") {
                            val = "Not Available";
                        }
                        if (has_summary && j === data.data[i].length - 2 && i === data.data.length - 1) {
                            td.style.textAlign = "right";
                        }
                        td.innerHTML = val;
                        row.appendChild(td);
                    }
                    tbody.appendChild(row);
                }
                table.appendChild(tbody);
                return table;
            }

            fetch(gene_json)
                .then((res) => res.json())
                .then((gene_data) => {
                    all_gene_data = gene_data;
                    let genelist = document.getElementById(gene_element);
                    for (let i = 0; i < gene_data.length; i++) {
                        let option = document.createElement("option");
                        option.value = gene_data[i];
                        genelist.appendChild(option);
                    }
                    if (window.location.search) {
                        let params = new URLSearchParams(window.location.search);

                        let gene_id = params.get("gene_id");
                        if (gene_id) {
                            document.getElementById("gene_id").value = gene_id;
                            gene_button.click();
                        }
                        else {
                            get_dag("RBM34");
                        }
                    } else {
                        get_dag("RBM34");
                    }
                });
            function get_dag(gene_id) {
                let clique_type = "gene";
                let dag_chart = create_dag(
                    echarts,
                    clique_type,
                    gene_id,
                    "dag",
                    (ignore_size = true),
                    (host = "../"),
                );
                dag_chart.then((chart) => {
                    chart.dispatchAction({
                        type: "highlight",
                        seriesIndex: 0,
                        name: gene_id,
                    });
                    displayed_chart = chart;
                    chart.resize();
                    let member_data = chart.getOption().series[0].nodes;
                    let member_list = document.getElementById("members");
                    let member_text = "<small style=\"color: var(--color-body-light)\">Sorted from highest to lowest random walk probability</small><p>";
                    for (let i = 0; i < member_data.length; i++) {
                        let member = member_data[i];
                        member_text += member.name;
                        if (i != member_data.length - 1) {
                            member_text += ", ";
                        }
                    }
                    member_text += "</p>";
                    member_list.innerHTML = member_text;
                    // let download_button = document.getElementById("download_button");
                    // download_button.onclick = function () {
                    //     download(chart.getOption().series[0], `${gene_id}_neighborhood.json`)
                    // };
                })

                fetch(`../data/go/gene/${gene_id}.json`)
                    .then((res) => res.json())
                    .then((data) => {
                        let table_body = document.getElementById("table_body");
                        document.getElementById("gene_title").innerHTML = `Gene: ${gene_id}`;
                        table_body.innerHTML = "";
                        let categories = ["gobp", "gomf", "gocc"];
                        let category_name = {
                            gobp: "Biological Process",
                            gomf: "Molecular Function",
                            gocc: "Cellular Component",
                        };
                        for (let i = 0; i < categories.length; i++) {
                            let go_cat = categories[i];
                            let row = document.createElement("tr");
                            let go_category = document.createElement("td");
                            let go_id = document.createElement("td");
                            let go_term = document.createElement("td");
                            let fdr = document.createElement("td");
                            go_category.innerHTML = category_name[go_cat];
                            let go_id_text = data[go_cat].set;
                            go_id.innerHTML = `<a href="https://amigo.geneontology.org/amigo/term/${go_id_text}" target="_blank">${go_id_text}</a>`;
                            go_term.innerHTML = data[go_cat].set_name;
                            let fdr_val = parseFloat(data[go_cat].fdr);
                            fdr.innerHTML = fdr_val != 0.0 ? fdr_val.toExponential(2) : "< 2.20e-16";
                            row.appendChild(go_category);
                            row.appendChild(go_id);
                            row.appendChild(go_term);
                            row.appendChild(fdr);
                            table_body.appendChild(row);
                        }
                    }).then(() => {
                        fetch(`../data/table/gene/${gene_id}.json`).then((res) => res.json()).then((clin_data) => {
                            const tumor_header = document.createElement("h5");
                            tumor_header.className = "info_heading";
                            tumor_header.innerHTML = "Tumor Expression by Cohort";
                            const tumor_subtitle = document.createElement("small");
                            tumor_subtitle.className = "subtitle";
                            tumor_subtitle.innerHTML = "The <i>p</i>-values were derived from difference in average protein abundance of clique genes between tumor and normal samples by Wilcoxon rank-sum test.";
                            const tumor_table = createTable(clin_data["tumor_expression"]);
                            let left_div = document.getElementById("left_div_child");
                            left_div.innerHTML = "";
                            left_div.appendChild(tumor_header);
                            left_div.appendChild(tumor_subtitle);
                            left_div.appendChild(tumor_table);
                            const surv_header = document.createElement("h5");
                            surv_header.className = "info_heading";
                            surv_header.innerHTML = "Patient Overall Survival by Cohort";
                            const surv_subtitle = document.createElement("small");
                            surv_subtitle.className = "subtitle";
                            surv_subtitle.innerHTML = "Logrank <i>p</i>-values were derived from Cox-proportional hazard models using average protein abundance of clique genes stratified by median.";
                            const survival_table = createTable(clin_data["survival"]);
                            left_div.appendChild(surv_header);
                            left_div.appendChild(surv_subtitle);
                            left_div.appendChild(survival_table);
                            if (displayed_chart) {
                                displayed_chart.resize();
                            }
                        });
                    });

            }
            let button = document.getElementById("search_button");
            button.addEventListener("click", function () {
                let gene_id = document.getElementById("gene_id").value;
                if (gene_id == "") {
                    document.getElementById("gene_search_error").innerHTML = "Please enter a gene symbol";
                    return;
                } else if (!all_gene_data.includes(gene_id)) {
                    document.getElementById("gene_search_error").innerHTML = `Gene symbol ${gene_id} not present in FunMap.<br>Please use the dropdown options to filter for genes.`;
                    return;
                }
                document.getElementById("gene_search_error").innerHTML = "";
                window.history.pushState({}, "", `?gene_id=${gene_id}`);
                get_dag(gene_id);
            });

            document
                .getElementById("gene_id")
                .addEventListener("keyup", function (event) {
                    event.preventDefault();
                    if (event.keyCode === 13) {
                        document.getElementById("search_button").click();
                    }
                });
        </script>
</body>

</html>