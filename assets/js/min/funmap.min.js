function uncollapse_children(a,b){const c=b.includes(a.name);if(a.children&&a.children.length>0){let d=false;for(let e=0;e<a.children.length;e++){if(b.includes(a.children[e].name)){x=uncollapse_children(a.children[e],b);a.children[e]=x[0];d=d||x[1]}}if(d){a.collapsed=false}}return[a,c]}function isInt(f){const g=parseInt(f);return!Number.isNaN(g)&&Number.isFinite(g)}function isNumeric(h){const i=parseFloat(h);return!Number.isNaN(i)&&Number.isFinite(i)}function toTitleCase(j){return j.replace(/\w\S*/g,k=>k.charAt(0).toUpperCase()+k.substr(1).toLowerCase())}function createTable(l){const m=document.createElement("table");const n=document.createElement("thead");const o=document.createElement("tbody");const p=document.createElement("tr");for(let u=0;u<l.columns.length;u++){const v=document.createElement("th");const w=l.columns[u];v.innerHTML=w;v.style.fontWeight="700";p.appendChild(v)}n.appendChild(p);m.appendChild(n);const q="spans"in l;let r=q?l.spans[0]:null;let s=0;let t=0;for(let y=0;y<l.data.length;y++){const z=document.createElement("tr");if(q){if(y===t){const A=document.createElement("td");A.innerHTML=r.content;A.rowSpan=r.count;z.appendChild(A);t+=r.count;s++;r=l.spans[s]}}for(let B=0;B<l.data[y].length;B++){const C=document.createElement("td");let D=l.data[y][B];if(isNumeric(D)){D=parseFloat(D);if(D===0){D="< 2.20e-16"}else if(Math.abs(D)>.001&&Math.abs(D)<1e3){D=D.toPrecision(3)}else{D=D.toExponential(2)}}else if(D==null||D==="None"){D="Not Available"}C.innerHTML=D;z.appendChild(C)}o.appendChild(z)}m.appendChild(o);return m}function funmap(E,F={}){const G=F.gene_json||"../data/genes.json";const H=F.gene_element||"genes";const I=F.gene_to_module||"../data/gene_to_module.json";const J=F.clinical_data_json||"../data/table/hierarchal_module/clinical_data.json";const K=F.funmap_json||"../data/funmap.json";const L=F.main_chart||"chart";const M=F.pie_chart||"pie_chart";let N={};let O=0;fetch(G).then(P=>P.json()).then(Q=>{genelist=document.getElementById(H);for(let R=0;R<Q.length;R++){const S=document.createElement("option");S.value=Q[R];genelist.appendChild(S)}}).then(()=>{fetch(I).then(T=>T.json()).then(U=>{fetch(J).then(V=>V.json()).then(W=>{N=W;fetch(K).then(X=>X.json()).then(Y=>{function Z(ha){if(ha.children&&ha.children.length>0){for(let ia=0;ia<ha.children.length;ia++){Z(ha.children[ia])}}if(ha.size<=50){ha.label={fontWeight:"bold"}}}Z(Y);const $={title:{text:"FunMap Hierarchal Organization",left:"center",textStyle:{fontSize:30,fontWeight:"bolder",color:"#333"}},tooltip:{trigger:"item",triggerOn:"mousemove",confine:true,borderColor:"var(--color-body)",padding:20,formatter:(ja,ka,la)=>{let ma="";if("hallmarks"in ja.data){for(let sa=0;sa<ja.data.hallmarks.length;sa++){ma+=toTitleCase(`${ja.data.hallmarks[sa]}, `)}ma=ma.slice(0,-2)}if(ma===""){ma="No Hallmarks"}const na=`<h5 style="margin-top: 0;max-width: 100%; text-align:center; word-break: normal; white-space: normal;">${ja.name}</h5><h6 style="max-width: 100%; text-align:center; word-break: normal; white-space: normal">Cancer Hallmarks: ${ma}</h6><br><h6 style="text-align:center;">Top GO Terms</h6>`;const oa=document.createElement("div");oa.innerHTML=na;const pa=createTable(N[ja.name].go_info);pa.style.maxWidth="100%";pa.className="tooltip_table";oa.appendChild(pa);const qa=createTable(N[ja.name].cohort_info);const ra=document.createElement("h6");ra.innerHTML="Cohort Information";ra.style.textAlign="center";oa.appendChild(ra);qa.style.maxWidth="100%";qa.className="tooltip_table";oa.appendChild(qa);oa.style.maxWidth="100%";oa.style.textAlign="center";oa.style.fontSize="0.55vw";oa.style.lineHeight="0.5vw";oa.style.color="var(--color-body)";return oa},extraCssText:"max-width: 30%;",className:"tooltip"},toolbox:{show:true,feature:{restore:{},saveAsImage:{}}},series:[{type:"tree",roam:true,name:"FunMap",data:[Y],top:"10%",bottom:"10%",left:"10%",right:"10%",layout:"radial",symbol:(ta,ua)=>{node=ua.data;if(node.children&&node.children.length>0&&ua.collapsed){return"diamond"}return"circle"},symbolSize:(va,wa)=>{node=wa.data;return node.name==="L1_M1"?51:.0273*node.size+19.454},initialTreeDepth:1,label:{position:"top",verticalAlign:"middle",align:"right",fontSize:12},leaves:{label:{position:"bottom",verticalAlign:"middle",align:"left"}},animationDuration:550,animationDurationUpdate:750,lineStyle:{width:7,color:"yellow"},itemStyle:{borderWidth:1,color:"yellow",borderColor:"black"},emphasis:{focus:"ancestor"}}],visualMap:{type:"continuous",min:-165,max:165,seriesIndex:0,title:{text:"Signed log10 meta-p",left:"center",top:"bottom"},text:["Signed log10 meta-p\n\nHigher in Tumor vs. Normal","Lower in Tumor vs. Normal"],precision:3,inRange:{color:["#67001f","#b2182b","#d6604d","#f4a582","#fddbc7","#f7f7f7","#d1e5f0","#92c5de","#4393c3","#2166ac","#053061"].reverse()}}};const _=E.init(document.getElementById(L));_.setOption($);window.addEventListener("resize",()=>{_.resize()});const aa=document.getElementById(M);const ba=E.init(aa);const ca={title:{text:"Hallmark Key",left:"center"},series:[{animationDuration:0,animationDurationUpdate:0,name:"Hallmark Key",type:"pie",radius:["40%","70%"],avoidLabelOverlap:false,itemStyle:{borderRadius:10,borderColor:"#fff",borderWidth:2},label:{show:false,position:"center"},emphasis:{animationDuration:50,label:{show:true,width:200,fontSize:18,fontWeight:"bold",overflow:"break"}},labelLine:{show:false},data:[{name:"EVADING GROWTH SUPPRESSORS",value:1,itemStyle:{color:"rgba(96, 50, 2, 0.55)"}},{name:"AVOIDING IMMUNE DESTRUCTION",value:1,itemStyle:{color:"rgba(194, 0, 126, 0.55)"}},{name:"ENABLING REPLICATIVE IMMORTALITY",value:1,itemStyle:{color:"rgba(13, 104, 161, 0.55)"}},{name:"TUMOR PROMOTING INFLAMMATION",value:1,itemStyle:{color:"rgba(213, 101, 23, 0.55)"}},{name:"ACTIVATING INVASION AND METASTASIS",value:1,itemStyle:{color:"rgba(25, 23, 24, 0.55)"}},{name:"INDUCING ANGIOGENESIS",value:1,itemStyle:{color:"rgba(232, 35, 40, 0.55)"}},{name:"GENOME INSTABILITY AND MUTATION",value:1,itemStyle:{color:"rgba(21, 41, 132, 0.55)"}},{name:"RESISTING CELL DEATH",value:1,itemStyle:{color:"rgba(112, 125, 134, 0.55)"}},{name:"DEREGULATING CELLULAR ENERGETICS",value:1,itemStyle:{color:"rgba(106, 42, 133, 0.55)"}},{name:"SUSTAINING PROLIFERATIVE SIGNALING",value:1,itemStyle:{color:"rgba(21, 143, 72, 0.55)"}},{name:"NONE",value:1,itemStyle:{color:"rgba(220, 211, 182, 0.55)"}}]}]};ca&&ba.setOption(ca);const da=create_dag(E,"hierarchal_modules","L2_M2","dag",false,"../");let ea=null;da.then(xa=>{ea=xa;_.on("mouseover",ya=>{update_dag_chart(ya.name)})});update_dag_chart=(za,Aa=null)=>{const Ba=update_dag(ea,"hierarchal_modules",za,"../");Ba.then(Ca=>{O++;if(Ca){ea=Ca;if(!is_open["dag-tab-container"]){dagTabContainer.dispatchEvent(new Event("click"))}if(Aa!=null){ea.dispatchAction({type:"highlight",seriesIndex:0,name:Aa})}}else{if(!is_open["dag-tab-container"]){dagTabContainer.dispatchEvent(new Event("click"))}setTimeout(Da=>{if(is_open["dag-tab-container"]&&Da===O){dagTabContainer.dispatchEvent(new Event("click"))}},2e3,O)}})};function fa(){ba.resize({width:aa.clientWidth,height:aa.clientHeight,animation:{duration:500}});setTimeout(()=>{ba.clear();ba.setOption(ca,true)},1)}new ResizeObserver(fa).observe(aa);ba.on("mouseover",Ea=>{const Fa=[];for(let Ga=0;Ga<$.series[0].data[0].children.length;Ga++){if($.series[0].data[0].children[Ga].hallmarks[0]===Ea.name){Fa.push($.series[0].data[0].children[Ga].name)}else if(Ea.name==="NONE"&&$.series[0].data[0].children[Ga].hallmarks.length===0){Fa.push($.series[0].data[0].children[Ga].name)}}_.dispatchAction({type:"highlight",seriesIndex:0,name:Fa})});const ga=document.getElementById("search_button");ga.addEventListener("click",Ha=>{const Ia=document.getElementById("gene_search").value;if(Ia in U){const Ja=U[Ia];let Ka=$.series[0].data[0];Ka=uncollapse_children(Ka,Ja)[0];const La=$;La.series[0].data[0]=Ka;_.setOption(La);_.dispatchAction({type:"highlight",seriesIndex:0,name:Ja});const Ma=document.getElementById("search_msg");Ma.className="search_info";Ma.innerHTML=`Gene found in modules: ${Ja.join(", ")}.`;update_dag_chart(Ja[Ja.length-1],Ia)}else{const Na=document.getElementById("search_msg");Na.className="search_error";Na.innerHTML="Gene not found in any module."}})})})})})}