function uncollapse_children(a,b){const c=b.includes(a.name);if(a.children&&a.children.length>0){let d=false;for(let e=0;e<a.children.length;e++){if(b.includes(a.children[e].name)){x=uncollapse_children(a.children[e],b);a.children[e]=x[0];d=d||x[1]}}if(d){a.collapsed=false}}return[a,c]}function isInt(f){const g=parseInt(f);return!Number.isNaN(g)&&Number.isFinite(g)}function isNumeric(h){const i=parseFloat(h);return!Number.isNaN(i)&&Number.isFinite(i)}function toTitleCase(j){return j.replace(/\w\S*/g,k=>k.charAt(0).toUpperCase()+k.substr(1).toLowerCase())}function createTable(l){const m=document.createElement("table");const n=document.createElement("thead");const o=document.createElement("tbody");const p=document.createElement("tr");for(let q=0;q<l.columns.length;q++){const r=document.createElement("th");const s=l.columns[q];r.innerHTML=s;p.appendChild(r)}n.appendChild(p);m.appendChild(n);for(let t=0;t<l.data.length;t++){const u=document.createElement("tr");for(let v=0;v<l.data[t].length;v++){const w=document.createElement("td");let y=l.data[t][v];if(isNumeric(y)){y=parseFloat(y);if(y===0){y="< 2.20e-16"}else if(Math.abs(y)>.001&&Math.abs(y)<1e3){y=y.toPrecision(3)}else{y=y.toExponential(2)}}else if(y==null||y==="None"){y="Not Available"}w.innerHTML=y;u.appendChild(w)}o.appendChild(u)}m.appendChild(o);return m}function funmap(z,A={}){const B=A.gene_json||"../data/genes.json";const C=A.gene_element||"genes";const D=A.gene_to_module||"../data/gene_to_module.json";const E=A.clinical_data_json||"../data/table/hierarchal_module/clinical_data.json";const F=A.funmap_json||"../data/funmap.json";const G=A.main_chart||"chart";const H=A.pie_chart||"pie_chart";let I={};let J=0;fetch(B).then(K=>K.json()).then(L=>{genelist=document.getElementById(C);for(let M=0;M<L.length;M++){const N=document.createElement("option");N.value=L[M];genelist.appendChild(N)}}).then(()=>{fetch(D).then(O=>O.json()).then(P=>{fetch(E).then(Q=>Q.json()).then(R=>{I=R;fetch(F).then(S=>S.json()).then(T=>{function U(ca){if(ca.children&&ca.children.length>0){for(let da=0;da<ca.children.length;da++){U(ca.children[da])}}if(ca.size<=50){ca.label={fontWeight:"bold"}}}U(T);const V={title:{text:"FunMap Hierarchal Organization",left:"center",textStyle:{fontSize:30,fontWeight:"bolder",color:"#333"}},tooltip:{trigger:"item",triggerOn:"mousemove",confine:true,formatter:(ea,fa,ga)=>{let ha="";if("hallmarks"in ea.data){for(let na=0;na<ea.data.hallmarks.length;na++){ha+=toTitleCase(`${ea.data.hallmarks[na]}, `)}ha=ha.slice(0,-2)}if(ha===""){ha="No Hallmarks"}const ia=`<h5 style="max-width: 100%; text-align:center; word-break: normal; white-space: normal;">${ea.name}</h5><h6 style="max-width: 100%; text-align:center; word-break: normal; white-space: normal">Cancer Hallmarks: ${ha}</h6><br><h6 style="text-align:center;">Top GO Terms</h6>`;const ja=document.createElement("div");ja.innerHTML=ia;const ka=createTable(I[ea.name].go_info);ka.style.maxWidth="100%";ka.className="tooltip_table";ja.appendChild(ka);const la=createTable(I[ea.name].cohort_info);const ma=document.createElement("h6");ma.innerHTML="Cohort Information";ma.style.textAlign="center";ja.appendChild(ma);la.style.maxWidth="100%";la.className="tooltip_table";ja.appendChild(la);ja.style.maxWidth="100%";ja.style.textAlign="center";ja.style.fontSize="0.55vw";ja.style.lineHeight="0.5vw";return ja},extraCssText:"max-width: 30%;",className:"tooltip"},toolbox:{show:true,feature:{restore:{},saveAsImage:{}}},series:[{type:"tree",roam:true,name:"FunMap",data:[T],top:"10%",bottom:"10%",left:"10%",right:"10%",layout:"radial",symbol:(oa,pa)=>{node=pa.data;if(node.children&&node.children.length>0&&pa.collapsed){return"diamond"}return"circle"},symbolSize:(qa,ra)=>{node=ra.data;return node.name==="L1_M1"?51:.0273*node.size+19.454},initialTreeDepth:1,label:{position:"top",verticalAlign:"middle",align:"right",fontSize:12},leaves:{label:{position:"bottom",verticalAlign:"middle",align:"left"}},animationDuration:550,animationDurationUpdate:750,lineStyle:{width:7,color:"yellow"},itemStyle:{borderWidth:1,color:"yellow",borderColor:"black"},emphasis:{focus:"ancestor"}}],visualMap:{type:"continuous",min:-165,max:165,seriesIndex:0,title:{text:"Signed log10 meta-p",left:"center",top:"bottom"},text:["Signed log10 meta-p\n\nHigher in Tumor vs. Normal","Lower in Tumor vs. Normal"],precision:3,inRange:{color:["#67001f","#b2182b","#d6604d","#f4a582","#fddbc7","#f7f7f7","#d1e5f0","#92c5de","#4393c3","#2166ac","#053061"].reverse()}}};const W=z.init(document.getElementById(G));W.setOption(V);window.addEventListener("resize",()=>{W.resize()});const X=document.getElementById(H);const Y=z.init(X);const Z={title:{text:"Hallmark Key",left:"center"},series:[{animationDuration:0,animationDurationUpdate:0,name:"Hallmark Key",type:"pie",radius:["40%","70%"],avoidLabelOverlap:false,itemStyle:{borderRadius:10,borderColor:"#fff",borderWidth:2},label:{show:false,position:"center"},emphasis:{animationDuration:50,label:{show:true,width:200,fontSize:18,fontWeight:"bold",overflow:"break"}},labelLine:{show:false},data:[{name:"EVADING GROWTH SUPPRESSORS",value:1,itemStyle:{color:"rgba(96, 50, 2, 0.55)"}},{name:"AVOIDING IMMUNE DESTRUCTION",value:1,itemStyle:{color:"rgba(194, 0, 126, 0.55)"}},{name:"ENABLING REPLICATIVE IMMORTALITY",value:1,itemStyle:{color:"rgba(13, 104, 161, 0.55)"}},{name:"TUMOR PROMOTING INFLAMMATION",value:1,itemStyle:{color:"rgba(213, 101, 23, 0.55)"}},{name:"ACTIVATING INVASION AND METASTASIS",value:1,itemStyle:{color:"rgba(25, 23, 24, 0.55)"}},{name:"INDUCING ANGIOGENESIS",value:1,itemStyle:{color:"rgba(232, 35, 40, 0.55)"}},{name:"GENOME INSTABILITY AND MUTATION",value:1,itemStyle:{color:"rgba(21, 41, 132, 0.55)"}},{name:"RESISTING CELL DEATH",value:1,itemStyle:{color:"rgba(112, 125, 134, 0.55)"}},{name:"DEREGULATING CELLULAR ENERGETICS",value:1,itemStyle:{color:"rgba(106, 42, 133, 0.55)"}},{name:"SUSTAINING PROLIFERATIVE SIGNALING",value:1,itemStyle:{color:"rgba(21, 143, 72, 0.55)"}},{name:"NONE",value:1,itemStyle:{color:"rgba(220, 211, 182, 0.55)"}}]}]};Z&&Y.setOption(Z);const $=create_dag(z,"hierarchal_modules","L2_M2","dag",false,"../");let _=null;$.then(sa=>{_=sa;W.on("mouseover",ta=>{update_dag_chart(ta.name)})});update_dag_chart=(ua,va=null)=>{const wa=update_dag(_,"hierarchal_modules",ua,"../");wa.then(xa=>{J++;if(xa){_=xa;if(!is_open["dag-tab-container"]){dagTabContainer.dispatchEvent(new Event("click"))}if(va!=null){_.dispatchAction({type:"highlight",seriesIndex:0,name:va})}}else{if(!is_open["dag-tab-container"]){dagTabContainer.dispatchEvent(new Event("click"))}setTimeout(ya=>{if(is_open["dag-tab-container"]&&ya===J){dagTabContainer.dispatchEvent(new Event("click"))}},2e3,J)}})};function aa(){Y.resize({width:X.clientWidth,height:X.clientHeight,animation:{duration:500}});setTimeout(()=>{Y.clear();Y.setOption(Z,true)},1)}new ResizeObserver(aa).observe(X);Y.on("mouseover",za=>{const Aa=[];for(let Ba=0;Ba<V.series[0].data[0].children.length;Ba++){if(V.series[0].data[0].children[Ba].hallmarks[0]===za.name){Aa.push(V.series[0].data[0].children[Ba].name)}else if(za.name==="NONE"&&V.series[0].data[0].children[Ba].hallmarks.length===0){Aa.push(V.series[0].data[0].children[Ba].name)}}W.dispatchAction({type:"highlight",seriesIndex:0,name:Aa})});const ba=document.getElementById("search_button");ba.addEventListener("click",Ca=>{const Da=document.getElementById("gene_search").value;if(Da in P){const Ea=P[Da];let Fa=V.series[0].data[0];Fa=uncollapse_children(Fa,Ea)[0];const Ga=V;Ga.series[0].data[0]=Fa;W.setOption(Ga);W.dispatchAction({type:"highlight",seriesIndex:0,name:Ea});const Ha=document.getElementById("search_msg");Ha.className="search_info";Ha.innerHTML=`Gene found in modules: ${Ea.join(", ")}.`;update_dag_chart(Ea[Ea.length-1],Da)}else{const Ia=document.getElementById("search_msg");Ia.className="search_error";Ia.innerHTML="Gene not found in any module."}})})})})})}